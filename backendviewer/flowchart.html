<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mira Flowchart</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap');

  :root {
    --bg: #08090d;
    --node-bg: #13151d;
    --node-border: #252838;
    --text: #b8bdd0;
    --text-bright: #e4e8f4;
    --text-dim: #4a5068;
    --red: #ef4444;
    --blue: #3b82f6;
    --green: #22c55e;
    --purple: #a855f7;
    --amber: #f59e0b;
    --cyan: #06b6d4;
    --pink: #ec4899;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    font-family: 'DM Sans', sans-serif;
    color: var(--text);
    overflow-x: hidden;
    min-height: 100vh;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .chart-container {
    position: relative;
    width: 1240px;
    height: 1700px;
    margin: 24px auto;
    transform: translateX(0);
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  body.video-shift-default .chart-container {
    transform: translateX(calc(-25vw + 100px));
  }
  body.video-shift-none .chart-container {
    transform: translateX(0);
  }
  body.video-shift-far .chart-container {
    transform: translateX(calc(-25vw - 40px));
  }

  svg.edges {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
  }

  .edge-line {
    fill: none;
    stroke-width: 1.5;
    stroke-linecap: round;
    transition: opacity 0.3s, stroke-width 0.3s, stroke 0.3s;
  }
  .edge-solid { stroke: #252838; }
  .edge-data { stroke: #252838; stroke-dasharray: 6 4; }

  .node {
    position: absolute;
    background: var(--node-bg);
    border: 1px solid var(--node-border);
    border-radius: 10px;
    padding: 12px 16px;
    cursor: default;
    transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s, opacity 0.3s;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 4px;
  }
  .node:hover {
    z-index: 10;
  }
  .node.has-video {
    cursor: pointer;
  }
  .node .icon { font-size: 20px; }
  .node .label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-bright);
    line-height: 1.3;
  }
  .node .sub {
    font-size: 10px;
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    line-height: 1.3;
  }

  .node.glow-red    { border-color: var(--red);    box-shadow: 0 0 20px rgba(239,68,68,0.1); }
  .node.glow-blue   { border-color: var(--blue);   box-shadow: 0 0 20px rgba(59,130,246,0.1); }
  .node.glow-green  { border-color: var(--green);  box-shadow: 0 0 20px rgba(34,197,94,0.1); }
  .node.glow-purple { border-color: var(--purple); box-shadow: 0 0 20px rgba(168,85,247,0.1); }
  .node.glow-amber  { border-color: var(--amber);  box-shadow: 0 0 20px rgba(245,158,11,0.1); }
  .node.glow-cyan   { border-color: var(--cyan);   box-shadow: 0 0 20px rgba(6,182,212,0.1); }
  .node.glow-pink   { border-color: var(--pink);   box-shadow: 0 0 20px rgba(236,72,153,0.1); }

  /* Hovered node itself */
  .node.hover-target {
    transform: scale(1.06);
    box-shadow: 0 0 32px rgba(0,0,0,0.6);
    z-index: 12;
  }

  /* Pipeline sibling highlight */
  .node.pipe-highlight {
    transform: scale(1.03);
  }

  /* Upstream source highlight ‚Äî different colored ring */
  .node.source-highlight {
    opacity: 1 !important;
    outline: 2px solid rgba(6, 182, 212, 0.5);
    outline-offset: 3px;
    animation: source-pulse 1.5s ease infinite;
  }
  @keyframes source-pulse {
    0%, 100% { outline-color: rgba(6, 182, 212, 0.5); }
    50% { outline-color: rgba(6, 182, 212, 0.2); }
  }

  /* Downstream target highlight */
  .node.target-highlight {
    opacity: 1 !important;
    outline: 2px solid rgba(245, 158, 11, 0.4);
    outline-offset: 3px;
    animation: target-pulse 1.5s ease infinite;
  }
  @keyframes target-pulse {
    0%, 100% { outline-color: rgba(245, 158, 11, 0.4); }
    50% { outline-color: rgba(245, 158, 11, 0.15); }
  }

  .region {
    position: absolute;
    border-radius: 14px;
    border: 1px dashed;
    z-index: 0;
    opacity: 0.5;
    transition: opacity 0.5s;
  }
  .region:hover { opacity: 0.8; }
  .region .region-label {
    position: absolute;
    top: 10px;
    left: 14px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .region .region-label img {
    width: 30px;
    height: 30px;
    object-fit: contain;
    border-radius: 5px;
    opacity: 1;
  }

  .region.offline  { border-color: rgba(59,130,246,0.2);  background: rgba(59,130,246,0.02); }
  .region.offline .region-label { color: var(--blue); }
  .region.online   { border-color: rgba(34,197,94,0.2);   background: rgba(34,197,94,0.02); }
  .region.online .region-label { color: var(--green); }
  .region.agent    { border-color: rgba(168,85,247,0.2);  background: rgba(168,85,247,0.02); }
  .region.agent .region-label { color: var(--purple); }
  .region.views    { border-color: rgba(236,72,153,0.15); background: rgba(236,72,153,0.015); }
  .region.views .region-label { color: var(--pink); }

  .bottom-panel {
    position: fixed;
    bottom: 16px;
    right: 24px;
    display: flex;
    flex-direction: column;
    gap: 0;
    z-index: 50;
  }
  .powered-by {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px 16px;
    background: rgba(19,21,29,0.85);
    backdrop-filter: blur(8px);
    border: 1px solid #1e2030;
    border-radius: 8px 8px 0 0;
    border-bottom: none;
    font-family: 'JetBrains Mono', monospace;
  }
  .powered-by .powered-label {
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--text-dim);
  }
  .powered-by .powered-logos {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .powered-by .powered-logos img {
    width: 24px;
    height: 24px;
    object-fit: contain;
    border-radius: 5px;
  }
  .legend {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    color: var(--text-dim);
    padding: 12px 16px;
    background: rgba(19,21,29,0.85);
    backdrop-filter: blur(8px);
    border: 1px solid #1e2030;
    border-radius: 0 0 8px 8px;
  }
  .legend span {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .legend .swatch {
    width: 20px;
    height: 2px;
    border-radius: 1px;
  }
  .legend .swatch.solid { background: #252838; }
  .legend .swatch.dashed {
    background: repeating-linear-gradient(90deg, #252838 0 6px, transparent 6px 10px);
  }
  /* Flow animation mode */
  .node.flow-active {
    border-color: var(--cyan) !important;
    box-shadow: 0 0 24px rgba(6,182,212,0.25), 0 0 48px rgba(6,182,212,0.08) !important;
    transform: scale(1.05);
    z-index: 12;
  }
  .node.flow-visited {
    border-color: rgba(6,182,212,0.35) !important;
    box-shadow: 0 0 12px rgba(6,182,212,0.1) !important;
  }
  .node.flow-dimmed {
    opacity: 0.12 !important;
  }
  .edge-line.flow-lit {
    stroke: rgba(6,182,212,0.7) !important;
    stroke-width: 2.5 !important;
    opacity: 1 !important;
  }
  .edge-line.flow-lit-trail {
    stroke: rgba(6,182,212,0.3) !important;
    stroke-width: 2 !important;
    opacity: 1 !important;
  }
  .edge-line.flow-dimmed {
    opacity: 0.05 !important;
  }

  .mode-toggle {
    position: fixed;
    top: 16px;
    right: 24px;
    z-index: 100;
    display: flex;
    gap: 0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  .mode-toggle button {
    padding: 8px 16px;
    border: 1px solid #252838;
    background: var(--node-bg);
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.25s;
  }
  .mode-toggle button:first-child { border-radius: 6px 0 0 6px; }
  .mode-toggle button:last-child { border-radius: 0 6px 6px 0; }
  .mode-toggle button + button { border-left: none; }
  .mode-toggle button.active {
    background: rgba(6,182,212,0.1);
    border-color: var(--cyan);
    color: var(--cyan);
  }


  .flow-nav {
    position: fixed;
    bottom: 24px;
    left: 24px;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: 'JetBrains Mono', monospace;
    opacity: 0;
    transition: opacity 0.4s;
    pointer-events: none;
  }
  .flow-nav.visible { opacity: 1; pointer-events: auto; }
  .flow-nav .flow-name {
    font-size: 11px;
    font-weight: 600;
    color: var(--cyan);
    background: rgba(6,182,212,0.06);
    border: 1px solid rgba(6,182,212,0.2);
    border-radius: 8px;
    padding: 8px 20px;
    white-space: nowrap;
  }
  .flow-nav .flow-counter {
    font-size: 9px;
    color: var(--text-dim);
    white-space: nowrap;
  }
  .flow-nav .flow-keys {
    display: flex;
    gap: 4px;
  }
  .flow-nav .key {
    font-size: 9px;
    color: var(--text-dim);
    border: 1px solid #252838;
    border-radius: 4px;
    padding: 3px 7px;
    background: var(--node-bg);
    line-height: 1;
    cursor: pointer;
    user-select: none;
  }
  .flow-nav .key:hover {
    background: #252838;
    color: #fff;
  }

  /* Showcase mode ‚Äî flashy pulse */
  .node.showcase-active {
    border-color: var(--pink) !important;
    box-shadow:
      0 0 30px rgba(236,72,153,0.35),
      0 0 60px rgba(236,72,153,0.15),
      inset 0 0 20px rgba(236,72,153,0.05) !important;
    transform: scale(1.08);
    z-index: 12;
    animation: showcase-glow 1.5s ease infinite;
  }
  @keyframes showcase-glow {
    0%, 100% { box-shadow: 0 0 30px rgba(236,72,153,0.35), 0 0 60px rgba(236,72,153,0.15); }
    50% { box-shadow: 0 0 40px rgba(236,72,153,0.5), 0 0 80px rgba(236,72,153,0.25); }
  }
  .node.showcase-dimmed {
    opacity: 0.08 !important;
  }
  .edge-line.showcase-dimmed {
    opacity: 0.03 !important;
  }
  .edge-line.showcase-lit {
    stroke: rgba(236,72,153,0.6) !important;
    stroke-width: 2.5 !important;
    opacity: 1 !important;
  }

  .mode-toggle button.active-showcase {
    background: rgba(236,72,153,0.1);
    border-color: var(--pink);
    color: var(--pink);
  }

  /* Active company badge ‚Äî upper left of page, shown on hover/highlight */
  .active-company {
    position: fixed;
    top: 16px;
    left: 24px;
    z-index: 99;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    border-radius: 10px;
    border: 1px solid #252838;
    background: rgba(19,21,29,0.9);
    backdrop-filter: blur(12px);
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-bright);
    letter-spacing: 0.3px;
    opacity: 0;
    transform: translateX(-10px);
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
  }
  .active-company.visible {
    opacity: 1;
    transform: translateX(0);
  }
  .active-company img {
    width: 28px;
    height: 28px;
    object-fit: contain;
    border-radius: 5px;
  }

  /* Corner logo on node ‚Äî upper left, shown on hover/highlight */
  .node .corner-logo {
    position: absolute;
    top: -16px;
    left: -16px;
    width: 38px;
    height: 38px;
    border-radius: 10px;
    border: 1px solid var(--node-border);
    background: var(--node-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: scale(0.6);
    transition: opacity 0.25s, transform 0.25s;
    pointer-events: none;
    z-index: 2;
  }
  .node .corner-logo img {
    width: 28px;
    height: 28px;
    object-fit: contain;
    border-radius: 3px;
  }
  .node.show-corner .corner-logo {
    opacity: 1;
    transform: scale(1);
  }

  /* Brand badges */
  .node .brand {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-top: 2px;
    padding: 2px 8px;
    border-radius: 4px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    line-height: 1.4;
  }
  .brand.modal       { background: rgba(83,180,126,0.12); color: #53b47e; }
  .brand.meta        { background: rgba(6,104,225,0.12);  color: #4a9af5; }
  .brand.openai      { background: rgba(255,255,255,0.08); color: #e4e8f4; }
  .brand.anthropic   { background: rgba(217,119,87,0.15); color: #d97757; }
  .brand.gemini      { background: rgba(66,133,244,0.12); color: #4285f4; }
  .brand.perplexity  { background: rgba(32,128,141,0.15); color: #20808d; }
  .brand.openevidence { background: rgba(100,160,255,0.12); color: #64a0ff; }
  .brand.whisper     { background: rgba(255,255,255,0.06); color: #a0a8c0; }
  .brand.cartesia    { background: rgba(168,85,247,0.12); color: #a855f7; }

  .brand .brand-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .brand .brand-logo {
    width: 20px; height: 20px;
    object-fit: contain;
    flex-shrink: 0;
    border-radius: 3px;
    transition: transform 0.3s, width 0.3s, height 0.3s;
  }
  .node.flow-active .brand .brand-logo {
    width: 26px; height: 26px;
  }

  .legend .source-swatch {
    width: 14px; height: 14px;
    border-radius: 4px;
    border: 2px solid rgba(6,182,212,0.5);
    background: transparent;
  }
  .legend .target-swatch {
    width: 14px; height: 14px;
    border-radius: 4px;
    border: 2px solid rgba(245,158,11,0.4);
    background: transparent;
  }

  /* Video preview panel ‚Äî right half of viewport */
  .video-preview {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 50vw;
    z-index: 200;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(8,9,13,0.92);
    backdrop-filter: blur(12px);
    border-left: 1px solid rgba(6,182,212,0.2);
    opacity: 0;
    transform: translateX(100%);
    transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1), transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }
  .video-preview.visible {
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
  }
  .video-preview video {
    display: block;
    max-width: 90%;
    max-height: 75vh;
    border-radius: 10px;
    border: 1px solid rgba(6,182,212,0.15);
    box-shadow: 0 8px 40px rgba(0,0,0,0.5);
  }
  .video-preview .video-label {
    margin-top: 12px;
    padding: 6px 16px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    color: var(--cyan);
    background: rgba(6,182,212,0.06);
    border: 1px solid rgba(6,182,212,0.15);
    border-radius: 6px;
    letter-spacing: 0.5px;
  }
</style>
</head>
<body>

<div class="mode-toggle">
  <button id="btn-explore" class="active">EXPLORE</button>
  <button id="btn-flow">DATA FLOW</button>
  <button id="btn-showcase">SHOWCASE</button>
</div>
<div class="active-company" id="activeCompany">
  <img id="activeCompanyLogo" src="" alt="">
  <span id="activeCompanyName"></span>
</div>

<div class="flow-nav" id="flowNav">
  <div class="flow-keys"><span class="key" id="btn-prev">‚Üê</span><span class="key" id="btn-next">‚Üí</span></div>
  <div class="flow-name" id="flowLabel"></div>
  <div class="flow-counter" id="flowCounter"></div>
</div>

<div class="chart-container" id="chart">

  <!-- ‚ïê‚ïê‚ïê REGIONS ‚ïê‚ïê‚ïê -->
  <div class="region offline" style="left:30px;  top:230px; width:460px; height:370px;"><div class="region-label">‚ë† Offline Processing <img src="logos/modal.png" alt="Modal"></div></div>
  <div class="region online"  style="left:520px; top:120px; width:690px; height:520px;"><div class="region-label">‚ë° Online Processing (real-time) <img src="logos/modal.png" alt="Modal"></div></div>
  <div class="region agent"   style="left:160px; top:710px; width:920px; height:440px;"><div class="region-label">‚ë¢ LLM Agent + Tools</div></div>
  <div class="region views"   style="left:300px; top:1320px; width:540px; height:280px;"><div class="region-label">Patient Experience</div></div>

  <!-- ‚ïê‚ïê‚ïê SVG EDGES ‚ïê‚ïê‚ïê -->
  <svg class="edges" id="edgeSvg">
    <defs>
      <marker id="arrow" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
        <path d="M 0 0 L 10 3.5 L 0 7 z" fill="#353a52"/>
      </marker>
      <marker id="arrow-lit" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
        <path d="M 0 0 L 10 3.5 L 0 7 z" fill="#06b6d4"/>
      </marker>
    </defs>
  </svg>

  <!-- ‚ïê‚ïê‚ïê NODES ‚ïê‚ïê‚ïê -->
  <div class="node glow-red" id="glasses" style="left:460px; top:20px; width:220px;">
    <span class="icon">üï∂Ô∏è</span>
    <span class="label">Meta Ray-Ban Glasses</span>
  </div>

  <div class="node glow-red" id="video" style="left:260px; top:135px; width:140px;">
    <span class="icon">üìπ</span>
    <span class="label">Video Stream</span>
  </div>
  <div class="node glow-red" id="mic" style="left:1050px; top:135px; width:130px;">
    <span class="icon">üé§</span>
    <span class="label">Microphone</span>
  </div>

  <!-- Offline -->
  <div class="node glow-blue" id="recon" style="left:50px; top:300px; width:140px;">
    <span class="icon">üèóÔ∏è</span>
    <span class="label">3D Reconstruction</span>
    <span class="sub">SfM / DUSt3R ¬∑ Point Cloud</span>

  </div>
  <div class="node glow-blue" id="objdet" style="left:210px; top:300px; width:130px;">
    <span class="icon">üè∑Ô∏è</span>
    <span class="label">Object Detection</span>
    <span class="sub">Grounding DINO</span>

  </div>
  <div class="node glow-blue" id="refimg" style="left:355px; top:310px; width:120px;">
    <span class="icon">üì∏</span>
    <span class="label">Reference Images</span>
    <span class="sub">stored features</span>
  </div>
  <div class="node glow-blue" id="objdb" style="left:160px; top:490px; width:150px;">
    <span class="icon">üóÑÔ∏è</span>
    <span class="label">3D Scene Object Graph</span>
    <span class="sub">label ‚Üí xyz</span>

  </div>

  <!-- Online ‚Äî Row 1: Localization -->
  <div class="node glow-green" id="dpvo" style="left:545px; top:210px; width:140px;">
    <span class="icon">üìç</span>
    <span class="label">Visual Odometry</span>
    <span class="sub">DPVO</span>

  </div>
  <div class="node glow-green" id="hloc" style="left:790px; top:210px; width:150px;">
    <span class="icon">üß≠</span>
    <span class="label">Re-Localization</span>
    <span class="sub">HLoc ¬∑ init anchor</span>

  </div>
  <div class="node glow-green" id="pose" style="left:820px; top:350px; width:150px;">
    <span class="icon">üéØ</span>
    <span class="label">6DoF User Pose</span>
    <span class="sub">position + heading</span>
  </div>

  <!-- Online ‚Äî Row 2: Tracking inputs -->
  <div class="node glow-green" id="depth" style="left:540px; top:350px; width:110px;">
    <span class="icon">üìê</span>
    <span class="label">Depth Map</span>
    <span class="sub">from camera</span>

  </div>
  <div class="node glow-green" id="masks" style="left:670px; top:350px; width:120px;">
    <span class="icon">üé≠</span>
    <span class="label">Object Masks</span>
    <span class="sub">from detection</span>

  </div>

  <!-- Online ‚Äî Row 3: Tracking -->
  <div class="node glow-green" id="obj-track" style="left:610px; top:500px; width:165px;">
    <span class="icon">üëÅÔ∏è</span>
    <span class="label">Live Object Tracking</span>

  </div>

  <div class="node glow-purple" id="stt" style="left:1050px; top:220px; width:130px;">
    <span class="icon">üó£Ô∏è</span>
    <span class="label">Speech-to-Text</span>
    <span class="sub">Whisper</span>
    <span class="brand whisper"><img class="brand-logo" src="logos/openai.png" alt="">OpenAI</span>
  </div>

  <!-- Agent -->
  <div class="node glow-amber" id="llm" style="left:520px; top:760px; width:160px;">
    <span class="icon">ü§ñ</span>
    <span class="label">LLM Agent</span>
    <span class="sub">Tool Calling</span>
    <span class="brand anthropic" id="llm-brand"><img class="brand-logo" id="llm-brand-logo" src="logos/claude.jpg" alt=""><span id="llm-brand-name">Claude</span></span>
  </div>
  <div class="node glow-cyan" id="tool-nav" style="left:190px; top:900px; width:150px;">
    <span class="icon">üß≠</span>
    <span class="label">Spatial Navigation</span>
    <span class="sub">locate + direct</span>
  </div>
  <div class="node glow-cyan" id="tool-patient" style="left:520px; top:930px; width:150px;">
    <span class="icon">üè•</span>
    <span class="label">Patient Info</span>
    <span class="sub">EHR / FHIR</span>
    <span class="brand openevidence"><img class="brand-logo" src="logos/openevidence.jpg" alt="">OpenEvidence</span>
  </div>
  <div class="node glow-cyan" id="tool-med" style="left:830px; top:900px; width:150px;">
    <span class="icon">üíä</span>
    <span class="label">Medication Lookup</span>
    <span class="sub">web search</span>
    <span class="brand perplexity"><img class="brand-logo" src="logos/perplexity.png" alt="">Perplexity</span>
  </div>
  <div class="node glow-purple" id="response" style="left:520px; top:1085px; width:160px;">
    <span class="icon">üí¨</span>
    <span class="label">Response Synthesis</span>
  </div>
  <div class="node glow-purple" id="tts" style="left:520px; top:1185px; width:160px;">
    <span class="icon">üîä</span>
    <span class="label">Text-to-Speech</span>
    <span class="brand whisper"><img class="brand-logo" src="logos/openai.png" alt="">OpenAI</span>
  </div>

  <!-- Views -->
  <div class="node glow-green" id="patient-view" style="left:400px; top:1380px; width:340px;">
    <span class="icon">üë§</span>
    <span class="label">Patient Experience</span>
    <span class="sub">Multimodal AR interface with spatial awareness</span>
  </div>

</div>

<!-- Legend ‚Äî fixed bottom-right -->
<div class="bottom-panel">
  <div class="powered-by">
    <span class="powered-label">Powered by</span>
    <div class="powered-logos">
      <img src="logos/modal.png" alt="Modal">
      <img src="logos/claude.jpg" alt="Anthropic">
      <img src="logos/openai.png" alt="OpenAI">
      <img src="logos/openevidence.jpg" alt="OpenEvidence">
      <img src="logos/perplexity.png" alt="Perplexity">
    </div>
  </div>
  <div class="legend">
    <span><span class="swatch solid"></span>Direct flow</span>
    <span><span class="swatch dashed"></span>Cross-pipeline data</span>
    <span><span class="source-swatch"></span>Upstream source</span>
    <span><span class="target-swatch"></span>Downstream target</span>
  </div>
</div>

<!-- Video Preview Panel -->
<div class="video-preview" id="videoPreview">
  <video id="previewVideo" muted loop playsinline></video>
  <div class="video-label" id="previewLabel"></div>
</div>

<script>
const edgeSvg = document.getElementById('edgeSvg');

const edges = [
  // Hardware
  ['glasses', 'video', 'solid', null],
  ['glasses', 'mic', 'solid', null],

  // Video ‚Üí Offline
  ['video', 'recon', 'solid', null],
  ['video', 'objdet', 'solid', null],
  ['video', 'refimg', 'solid', null],

  // Offline internal
  ['recon', 'objdb', 'solid', null],
  ['objdet', 'objdb', 'solid', null],

  // Video ‚Üí Online
  ['video', 'dpvo', 'solid', null],
  ['video', 'hloc', 'solid', null, [[460, 145], [620, 170], [740, 185]]],
  ['video', 'depth', 'solid', null],

  // Online internal ‚Äî localization
  ['dpvo', 'pose', 'solid', null],
  ['hloc', 'dpvo', 'solid', null],  // anchors DPVO on init

  // Tracking inputs ‚Üí tracker
  ['depth', 'obj-track', 'solid', null],
  ['masks', 'obj-track', 'solid', null],
  ['pose', 'obj-track', 'data', '#22c55e'],
  ['obj-track', 'tool-nav', 'data', '#22c55e'],

  // Mic ‚Üí STT
  ['mic', 'stt', 'solid', null],

  // Cross-pipeline: offline ‚Üí online
  ['refimg', 'hloc', 'data', '#3b82f6'],
  ['video', 'masks', 'solid', null],  // video stream feeds object masking

  // STT ‚Üí LLM
  ['stt', 'llm', 'solid', null],

  // Online ‚Üí Agent
  ['pose', 'tool-nav', 'data', '#22c55e'],
  ['objdb', 'tool-nav', 'data', '#3b82f6'],
  ['recon', 'tool-nav', 'data', '#3b82f6'],

  // LLM ‚Üí Tools
  ['llm', 'tool-nav', 'solid', null],
  ['llm', 'tool-patient', 'solid', null],
  ['llm', 'tool-med', 'solid', null],

  // Tools ‚Üí Response
  ['tool-nav', 'response', 'data', '#06b6d4'],
  ['tool-patient', 'response', 'data', '#06b6d4'],
  ['tool-med', 'response', 'data', '#06b6d4'],
  ['llm', 'response', 'solid', null],

  // Response ‚Üí TTS
  ['response', 'tts', 'solid', null],

  // Output ‚Üí Views
  ['tts', 'patient-view', 'solid', null],

  // 3D feeds ‚Üí Patient Experience (routed along left side to avoid agent region)
  ['recon', 'patient-view', 'data', '#3b82f6', [[60, 700], [60, 1200], [350, 1400]]],
  ['objdb', 'patient-view', 'data', '#3b82f6', [[130, 700], [100, 1200], [380, 1420]]],
];

const pipelineGroups = {
  hardware: ['glasses', 'video', 'mic'],
  offline: ['recon', 'objdet', 'refimg', 'objdb'],
  online: ['dpvo', 'hloc', 'depth', 'masks', 'obj-track', 'pose', 'stt'],
  agent: ['llm', 'tool-nav', 'tool-patient', 'tool-med', 'response', 'tts'],
  views: ['patient-view'],
};

// Build adjacency index
const incomingEdges = {};  // nodeId ‚Üí [fromId, ...]
const outgoingEdges = {};  // nodeId ‚Üí [toId, ...]
edges.forEach(([from, to]) => {
  if (!incomingEdges[to]) incomingEdges[to] = [];
  incomingEdges[to].push(from);
  if (!outgoingEdges[from]) outgoingEdges[from] = [];
  outgoingEdges[from].push(to);
});

function getNodeRect(id) {
  const el = document.getElementById(id);
  const chart = document.getElementById('chart');
  const cr = el.getBoundingClientRect();
  const pr = chart.getBoundingClientRect();
  return {
    x: cr.left - pr.left + cr.width / 2,
    y: cr.top - pr.top + cr.height / 2,
    top: cr.top - pr.top,
    bottom: cr.top - pr.top + cr.height,
    left: cr.left - pr.left,
    right: cr.left - pr.left + cr.width,
    w: cr.width, h: cr.height
  };
}

function getConnectionPoints(fromId, toId) {
  const f = getNodeRect(fromId);
  const t = getNodeRect(toId);
  const dx = t.x - f.x;
  const dy = t.y - f.y;
  let x1, y1, x2, y2;

  const absDx = Math.abs(dx);
  const absDy = Math.abs(dy);

  // Decide exit/entry sides based on relative position
  if (absDy > 30 && absDy > absDx * 0.5) {
    // Primarily vertical ‚Äî use top/bottom ports
    if (dy > 0) { y1 = f.bottom; y2 = t.top; }
    else { y1 = f.top; y2 = t.bottom; }
    x1 = f.x; x2 = t.x;
  } else {
    // Primarily horizontal ‚Äî use left/right ports
    if (dx > 0) { x1 = f.right; x2 = t.left; }
    else { x1 = f.left; x2 = t.right; }
    y1 = f.y; y2 = t.y;
  }
  return { x1, y1, x2, y2 };
}

function makePathSmart(x1, y1, x2, y2) {
  const dx = x2 - x1;
  const dy = y2 - y1;
  const absDx = Math.abs(dx);
  const absDy = Math.abs(dy);

  // Primarily vertical paths ‚Äî use vertical bezier
  if (absDy > absDx * 0.8) {
    const tension = Math.min(absDy * 0.45, 60);
    return `M ${x1} ${y1} C ${x1} ${y1 + Math.sign(dy) * tension}, ${x2} ${y2 - Math.sign(dy) * tension}, ${x2} ${y2}`;
  }
  // Primarily horizontal paths ‚Äî use horizontal bezier
  if (absDx > absDy * 0.8) {
    const tension = Math.min(absDx * 0.45, 60);
    return `M ${x1} ${y1} C ${x1 + Math.sign(dx) * tension} ${y1}, ${x2 - Math.sign(dx) * tension} ${y2}, ${x2} ${y2}`;
  }
  // Diagonal ‚Äî S-curve
  const midY = (y1 + y2) / 2;
  return `M ${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}`;
}

function makePath(x1, y1, x2, y2) {
  return makePathSmart(x1, y1, x2, y2);
}

const pathEls = [];

// Catmull-Rom to cubic bezier conversion for smooth waypoint paths
function catmullRomToBezier(pts, tension) {
  tension = tension || 0.5;
  const n = pts.length;
  if (n < 2) return `M ${pts[0][0]} ${pts[0][1]}`;
  if (n === 2) return makePath(pts[0][0], pts[0][1], pts[1][0], pts[1][1]);

  let d = `M ${pts[0][0]} ${pts[0][1]}`;
  for (let i = 0; i < n - 1; i++) {
    const p0 = pts[Math.max(i - 1, 0)];
    const p1 = pts[i];
    const p2 = pts[i + 1];
    const p3 = pts[Math.min(i + 2, n - 1)];

    const cp1x = p1[0] + (p2[0] - p0[0]) * tension / 3;
    const cp1y = p1[1] + (p2[1] - p0[1]) * tension / 3;
    const cp2x = p2[0] - (p3[0] - p1[0]) * tension / 3;
    const cp2y = p2[1] - (p3[1] - p1[1]) * tension / 3;

    d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2[0]} ${p2[1]}`;
  }
  return d;
}

edges.forEach(([fromId, toId, type, color, waypoints]) => {
  let d;
  if (waypoints && waypoints.length > 0) {
    const f = getNodeRect(fromId);
    const t = getNodeRect(toId);
    // Pick smart exit/entry points
    const { x1, y1, x2, y2 } = getConnectionPoints(fromId, toId);
    const allPts = [[x1, y1], ...waypoints, [x2, y2]];
    d = catmullRomToBezier(allPts, 0.5);
  } else {
    const { x1, y1, x2, y2 } = getConnectionPoints(fromId, toId);
    d = makePath(x1, y1, x2, y2);
  }

  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  path.setAttribute('d', d);
  path.setAttribute('class', `edge-line edge-${type}`);
  path.setAttribute('marker-end', 'url(#arrow)');
  path.dataset.from = fromId;
  path.dataset.to = toId;

  if (color) {
    const r = parseInt(color.slice(1,3),16);
    const g = parseInt(color.slice(3,5),16);
    const b = parseInt(color.slice(5,7),16);
    path.style.stroke = `rgba(${r},${g},${b},0.25)`;
    path.dataset.color = color;
  }

  edgeSvg.appendChild(path);
  pathEls.push({ path, fromId, toId, type, color });
});

// ‚îÄ‚îÄ Particles (explore mode) ‚îÄ‚îÄ
const particleEls = [];
pathEls.forEach(({ path, color }) => {
  // 2 particles per colored edge, 1 per solid edge
  const count = color ? 2 : 1;
  for (let i = 0; i < count; i++) {
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('r', color ? '2.5' : '2');
    circle.setAttribute('fill', color || '#4a5068');
    circle.setAttribute('opacity', '0');
    edgeSvg.appendChild(circle);
    particleEls.push({
      circle, path,
      delay: Math.random() * 4000 + i * 2000,
      speed: 1800 + Math.random() * 2200,
      color
    });
  }
});

let particleStart = null;
function animateParticles(ts) {
  if (!particleStart) particleStart = ts;
  const elapsed = ts - particleStart;
  const show = currentMode === 'explore';
  particleEls.forEach(({ circle, path, delay, speed, color }) => {
    if (!show) { circle.setAttribute('opacity', '0'); return; }
    const len = path.getTotalLength();
    if (len < 1) { circle.setAttribute('opacity', '0'); return; }
    const t = ((elapsed - delay) % speed + speed) % speed / speed;
    const pt = path.getPointAtLength(t * len);
    circle.setAttribute('cx', pt.x);
    circle.setAttribute('cy', pt.y);
    let op = color ? 0.7 : 0.35;
    if (t < 0.08) op *= t / 0.08;
    if (t > 0.88) op *= (1 - t) / 0.12;
    circle.setAttribute('opacity', Math.max(0, op));
  });
  requestAnimationFrame(animateParticles);
}
requestAnimationFrame(animateParticles);

function getPipeline(id) {
  for (const [k, ids] of Object.entries(pipelineGroups)) {
    if (ids.includes(id)) return k;
  }
  return null;
}

let activeVideoNode = null;

// ‚îÄ‚îÄ Company data per node ‚îÄ‚îÄ
const nodeCompanyMap = {
  'recon':       { logo: 'logos/modal.png',         name: 'Modal' },
  'objdet':      { logo: 'logos/modal.png',         name: 'Modal' },
  'objdb':       { logo: 'logos/modal.png',         name: 'Modal' },
  'dpvo':        { logo: 'logos/modal.png',         name: 'Modal' },
  'hloc':        { logo: 'logos/modal.png',         name: 'Modal' },
  'depth':       { logo: 'logos/modal.png',         name: 'Modal' },
  'masks':       { logo: 'logos/modal.png',         name: 'Modal' },
  'obj-track':   { logo: 'logos/modal.png',         name: 'Modal' },
  'pose':        { logo: 'logos/modal.png',         name: 'Modal' },
  'stt':         { logo: 'logos/openai.png',        name: 'OpenAI' },
  'llm':         { logo: 'logos/claude.jpg',        name: 'Anthropic' },
  'tool-patient':{ logo: 'logos/openevidence.jpg',  name: 'OpenEvidence' },
  'tool-med':    { logo: 'logos/perplexity.png',    name: 'Perplexity' },
  'tts':         { logo: 'logos/openai.png',        name: 'OpenAI' },
};

// Inject corner logo into every node that has a company
Object.entries(nodeCompanyMap).forEach(([id, { logo }]) => {
  const el = document.getElementById(id);
  if (!el) return;
  const corner = document.createElement('div');
  corner.className = 'corner-logo';
  corner.innerHTML = `<img src="${logo}" alt="">`;
  el.appendChild(corner);
});

const activeCompanyEl = document.getElementById('activeCompany');
const activeCompanyLogo = document.getElementById('activeCompanyLogo');
const activeCompanyName = document.getElementById('activeCompanyName');

function showCompanyBadge(nodeId) {
  const company = nodeCompanyMap[nodeId];
  if (!company) {
    hideCompanyBadge();
    return;
  }
  activeCompanyLogo.src = company.logo;
  activeCompanyName.textContent = company.name;
  activeCompanyEl.classList.add('visible');
  // Show corner logo on the node
  const el = document.getElementById(nodeId);
  if (el) el.classList.add('show-corner');
}

function hideCompanyBadge() {
  activeCompanyEl.classList.remove('visible');
  document.querySelectorAll('.node.show-corner').forEach(n => n.classList.remove('show-corner'));
}

function clearAllHighlights() {
  document.querySelectorAll('.node').forEach(n => {
    n.style.opacity = '1';
    n.classList.remove('hover-target', 'pipe-highlight', 'source-highlight', 'target-highlight');
  });
  pathEls.forEach(({ path }) => {
    path.style.opacity = '1';
    path.style.strokeWidth = '1.5';
    path.setAttribute('marker-end', 'url(#arrow)');
  });
  hideCompanyBadge();
}

function highlightNode(nodeId) {
  clearAllHighlights();
  const node = document.getElementById(nodeId);
  const pipe = getPipeline(nodeId);
  const group = pipe ? pipelineGroups[pipe] : [];

  const sources = incomingEdges[nodeId] || [];
  const targets = outgoingEdges[nodeId] || [];
  const connected = new Set([...sources, ...targets, nodeId, ...group]);

  document.querySelectorAll('.node').forEach(n => {
    if (!connected.has(n.id)) n.style.opacity = '0.15';
  });

  node.classList.add('hover-target');
  showCompanyBadge(nodeId);

  group.forEach(id => {
    if (id !== nodeId) document.getElementById(id).classList.add('pipe-highlight');
  });

  sources.forEach(id => {
    if (!group.includes(id)) document.getElementById(id).style.opacity = '1';
    document.getElementById(id).classList.add('source-highlight');
  });

  targets.forEach(id => {
    if (!group.includes(id)) document.getElementById(id).style.opacity = '1';
    document.getElementById(id).classList.add('target-highlight');
  });

  pathEls.forEach(({ path, fromId, toId, color }) => {
    const isDirectEdge = (fromId === nodeId || toId === nodeId);
    const isPipeEdge = group.includes(fromId) && group.includes(toId);

    if (isDirectEdge) {
      if (color) {
        const r = parseInt(color.slice(1,3),16);
        const g = parseInt(color.slice(3,5),16);
        const b = parseInt(color.slice(5,7),16);
        path.style.stroke = `rgba(${r},${g},${b},0.8)`;
      } else {
        path.style.stroke = 'rgba(200, 210, 230, 0.5)';
      }
      path.style.strokeWidth = '2.5';
      path.style.opacity = '1';
      path.setAttribute('marker-end', 'url(#arrow-lit)');
    } else if (isPipeEdge) {
      path.style.opacity = '0.4';
      path.style.strokeWidth = '1.5';
    } else {
      path.style.opacity = '0.06';
    }
  });
}

document.querySelectorAll('.node').forEach(node => {
  node.addEventListener('mouseenter', () => {
    if (!hoverListenersActive) return;
    if (activeVideoNode) return;
    highlightNode(node.id);
  });

  node.addEventListener('mouseleave', () => {
    if (!hoverListenersActive) return;
    if (activeVideoNode) return;
    clearAllHighlights();
  });
});

// ‚îÄ‚îÄ Data Flow Paths ‚îÄ‚îÄ
const flowPaths = [
  {
    name: 'Video ‚Üí 3D Reconstruction ‚Üí Scene Object Graph',
    nodes: ['glasses', 'video', 'recon', 'objdb'],
  },
  {
    name: 'Video ‚Üí Object Detection ‚Üí Scene Object Graph',
    nodes: ['glasses', 'video', 'objdet', 'objdb'],
  },
  {
    name: 'Video ‚Üí Visual Odometry ‚Üí 6DoF Pose ‚Üí Navigation',
    nodes: ['glasses', 'video', 'dpvo', 'pose', 'tool-nav'],
  },
  {
    name: 'Video ‚Üí Reference Images ‚Üí Re-Localization ‚Üí Anchors DPVO',
    nodes: ['glasses', 'video', 'refimg', 'hloc', 'dpvo', 'pose'],
  },
  {
    name: 'Video ‚Üí Depth + Masks + Pose ‚Üí Object Tracking ‚Üí Live State',
    nodes: ['glasses', 'video', 'depth', 'masks', 'obj-track'],
  },
  {
    name: 'Voice ‚Üí Speech-to-Text ‚Üí LLM Agent ‚Üí Response ‚Üí TTS ‚Üí Patient',
    nodes: ['glasses', 'mic', 'stt', 'llm', 'response', 'tts', 'patient-view'],
  },
  {
    name: 'LLM ‚Üí Patient Info ‚Üí Response ‚Üí TTS ‚Üí Patient',
    nodes: ['llm', 'tool-patient', 'response', 'tts', 'patient-view'],
  },
  {
    name: 'LLM ‚Üí Medication Lookup ‚Üí Response ‚Üí TTS',
    nodes: ['llm', 'tool-med', 'response', 'tts', 'patient-view'],
  },
  {
    name: 'LLM ‚Üí Spatial Navigation ‚Üí Response',
    nodes: ['llm', 'tool-nav', 'response'],
  },
  {
    name: '3D Reconstruction + Scene Graph ‚Üí Patient Experience',
    nodes: ['recon', 'objdb', 'patient-view'],
  },
];

// ‚îÄ‚îÄ Mode Management ‚îÄ‚îÄ
let currentMode = 'explore';
let flowRunning = false;
let currentFlowIndex = 0;
let flowAbort = null;
let flowSkipped = false; // set true when user manually skips

const btnExplore = document.getElementById('btn-explore');
const btnFlow = document.getElementById('btn-flow');
const btnShowcase = document.getElementById('btn-showcase');
const flowLabel = document.getElementById('flowLabel');
const flowNav = document.getElementById('flowNav');
const flowCounter = document.getElementById('flowCounter');

function setMode(mode) {
  // Stop any running animation from previous mode
  stopFlowAnimation();
  stopShowcase();
  clearAllHighlights();
  clearFlowHighlights();
  clearShowcaseHighlights();
  hideVideoPreview();
  flowNav.classList.remove('visible');

  currentMode = mode;
  btnExplore.classList.remove('active', 'active-showcase');
  btnFlow.classList.remove('active', 'active-showcase');
  btnShowcase.classList.remove('active', 'active-showcase');

  if (mode === 'explore') {
    btnExplore.classList.add('active');
    enableHoverListeners(true);
  } else if (mode === 'flow') {
    btnFlow.classList.add('active');
    enableHoverListeners(false);
    startFlowAnimation();
  } else if (mode === 'showcase') {
    btnShowcase.classList.add('active-showcase');
    enableHoverListeners(false);
    startShowcase();
  }
}

btnExplore.addEventListener('click', () => setMode('explore'));
btnFlow.addEventListener('click', () => setMode('flow'));
btnShowcase.addEventListener('click', () => setMode('showcase'));

// ‚îÄ‚îÄ Hover listener toggle ‚îÄ‚îÄ
let hoverListenersActive = true;
function enableHoverListeners(enabled) {
  hoverListenersActive = enabled;
  if (!enabled) clearAllHighlights();
}

// ‚îÄ‚îÄ Flow animation helpers ‚îÄ‚îÄ
function clearFlowHighlights() {
  document.querySelectorAll('.node').forEach(n => {
    n.classList.remove('flow-active', 'flow-visited', 'flow-dimmed');
    n.style.opacity = '';
  });
  pathEls.forEach(({ path }) => {
    path.classList.remove('flow-lit', 'flow-lit-trail', 'flow-dimmed');
  });
}

function findEdgePath(fromId, toId) {
  return pathEls.find(e => e.fromId === fromId && e.toId === toId);
}

function scrollToNode(nodeId) {
  const el = document.getElementById(nodeId);
  if (!el) return;
  const rect = el.getBoundingClientRect();
  const viewH = window.innerHeight;
  const margin = 120;
  if (rect.top < margin || rect.bottom > viewH - margin) {
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function updateFlowCounter() {
  flowCounter.textContent = `${currentFlowIndex + 1} / ${flowPaths.length}`;
}

// Cancellable sleep ‚Äî resolves false if skipped
function flowSleep(ms) {
  const mult = window.flowSpeedMultiplier || 1;
  return new Promise(resolve => {
    const id = setTimeout(() => resolve(true), ms * mult);
    flowAbort = () => { clearTimeout(id); resolve(false); };
  });
}

async function animateFlowPath(flowPath) {
  const { name, nodes } = flowPath;
  flowLabel.textContent = name;
  flowNav.classList.add('visible');
  updateFlowCounter();

  const pathNodeSet = new Set(nodes);

  document.querySelectorAll('.node').forEach(n => {
    if (!pathNodeSet.has(n.id)) n.classList.add('flow-dimmed');
  });
  pathEls.forEach(({ path }) => path.classList.add('flow-dimmed'));

  for (let i = 0; i < nodes.length; i++) {
    if (!flowRunning) return;

    const nodeId = nodes[i];
    const el = document.getElementById(nodeId);

    if (i > 0) {
      const prevId = nodes[i - 1];
      const edge = findEdgePath(prevId, nodeId);
      if (edge) {
        edge.path.classList.remove('flow-dimmed');
        edge.path.classList.add('flow-lit');
      }
      const prevEl = document.getElementById(prevId);
      prevEl.classList.remove('flow-active');
      prevEl.classList.add('flow-visited');
    }

    el.classList.remove('flow-dimmed');
    el.classList.add('flow-active');
    scrollToNode(nodeId);

    const hasVideo = !!nodeVideoMap[nodeId];
    const ok = await flowSleep(hasVideo ? 2400 : 600);
    if (!ok || !flowRunning) return;

    if (i > 0) {
      const prevId = nodes[i - 1];
      const edge = findEdgePath(prevId, nodeId);
      if (edge) {
        edge.path.classList.remove('flow-lit');
        edge.path.classList.add('flow-lit-trail');
      }
    }
  }

  const ok2 = await flowSleep(1200);
  if (!ok2 || !flowRunning) return;

  clearFlowHighlights();
  await flowSleep(300);
}

async function flowLoop() {
  flowRunning = true;
  while (flowRunning) {
    flowSkipped = false;
    await animateFlowPath(flowPaths[currentFlowIndex]);
    if (!flowRunning) break;
    if (!flowSkipped) {
      currentFlowIndex = (currentFlowIndex + 1) % flowPaths.length;
    }
  }
}

function skipToFlow(idx) {
  if (currentMode !== 'flow') return;
  flowSkipped = true;
  currentFlowIndex = ((idx % flowPaths.length) + flowPaths.length) % flowPaths.length;
  clearFlowHighlights();
  if (flowAbort) flowAbort();
}

function startFlowAnimation() {
  stopFlowAnimation();
  flowLoop();
}

function stopFlowAnimation() {
  flowRunning = false;
  if (flowAbort) flowAbort();
  clearFlowHighlights();
}

// ‚îÄ‚îÄ Showcase Mode ‚îÄ‚îÄ
let showcaseRunning = false;
let showcaseAbort = null;
let showcaseIndex = 0;
const showcaseNodeIds = []; // filled after nodeVideoMap is defined (see below)

function clearShowcaseHighlights() {
  document.querySelectorAll('.node').forEach(n => {
    n.classList.remove('showcase-active', 'showcase-dimmed');
    n.style.opacity = '';
  });
  pathEls.forEach(({ path }) => {
    path.classList.remove('showcase-lit', 'showcase-dimmed');
  });
  hideCompanyBadge();
}

function showcaseSleep(ms) {
  return new Promise(resolve => {
    const id = setTimeout(() => resolve(true), ms);
    showcaseAbort = () => { clearTimeout(id); resolve(false); };
  });
}

async function showcaseLoop() {
  showcaseRunning = true;
  while (showcaseRunning) {
    const nodeId = showcaseNodeIds[showcaseIndex];
    clearShowcaseHighlights();

    const pipe = getPipeline(nodeId);
    const group = pipe ? pipelineGroups[pipe] : [];
    const sources = incomingEdges[nodeId] || [];
    const targets = outgoingEdges[nodeId] || [];
    const connected = new Set([...sources, ...targets, nodeId, ...group]);

    // Dim non-connected nodes, show connected ones
    document.querySelectorAll('.node').forEach(n => {
      if (!connected.has(n.id)) {
        n.classList.add('showcase-dimmed');
      }
    });

    // Light connected edges, dim the rest
    pathEls.forEach(({ path, fromId, toId }) => {
      const isDirectEdge = (fromId === nodeId || toId === nodeId);
      const isPipeEdge = group.includes(fromId) && group.includes(toId);
      if (isDirectEdge) {
        path.classList.add('showcase-lit');
      } else if (!isPipeEdge) {
        path.classList.add('showcase-dimmed');
      }
    });

    // Highlight the active node
    const el = document.getElementById(nodeId);
    el.classList.add('showcase-active');
    showCompanyBadge(nodeId);
    scrollToNode(nodeId);
    showVideoPreview(nodeId, true);

    // Show label in flow nav
    const mapping = nodeVideoMap[nodeId];
    flowLabel.textContent = mapping ? mapping.label : nodeId;
    flowCounter.textContent = `${showcaseIndex + 1} / ${showcaseNodeIds.length}`;
    flowNav.classList.add('visible');

    const ok = await showcaseSleep(2400);
    if (!ok || !showcaseRunning) break;

    showcaseIndex = (showcaseIndex + 1) % showcaseNodeIds.length;
  }
}

function startShowcase() {
  stopShowcase();
  showcaseRunning = true;
  showcaseLoop();
}

function stopShowcase() {
  showcaseRunning = false;
  if (showcaseAbort) showcaseAbort();
  clearShowcaseHighlights();
}

// ‚îÄ‚îÄ Arrow key navigation ‚îÄ‚îÄ
document.addEventListener('keydown', (e) => {
  if (currentMode === 'flow') {
    if (e.key === 'ArrowRight') {
      e.preventDefault();
      skipToFlow(currentFlowIndex + 1);
    } else if (e.key === 'ArrowLeft') {
      e.preventDefault();
      skipToFlow(currentFlowIndex - 1);
    }
  }
  if (currentMode === 'showcase') {
    if (e.key === 'ArrowRight') {
      e.preventDefault();
      showcaseIndex = (showcaseIndex + 1) % showcaseNodeIds.length;
      clearShowcaseHighlights();
      if (showcaseAbort) showcaseAbort();
    } else if (e.key === 'ArrowLeft') {
      e.preventDefault();
      showcaseIndex = (showcaseIndex - 1 + showcaseNodeIds.length) % showcaseNodeIds.length;
      clearShowcaseHighlights();
      if (showcaseAbort) showcaseAbort();
    }
  }

  // Mode hotkeys
  if (e.key === '1') { setMode('explore'); return; }
  if (e.key === '2') { setMode('flow'); return; }
  if (e.key === '3') { setMode('showcase'); return; }

  // LLM switcher ‚Äî works in any mode
  const llmBrand = document.getElementById('llm-brand');
  const llmBrandLogo = document.getElementById('llm-brand-logo');
  const llmBrandName = document.getElementById('llm-brand-name');

  if (e.key === 'a' || e.key === 'A') {
    llmBrand.className = 'brand anthropic';
    llmBrandLogo.src = 'logos/claude.jpg';
    llmBrandName.textContent = 'Claude';
  } else if (e.key === 's' || e.key === 'S') {
    llmBrand.className = 'brand openai';
    llmBrandLogo.src = 'logos/openai.png';
    llmBrandName.textContent = 'GPT-4o';
  } else if (e.key === 'd' || e.key === 'D') {
    llmBrand.className = 'brand gemini';
    llmBrandLogo.src = 'logos/gemini.webp';
    llmBrandName.textContent = 'Gemini';
  }
});

// ‚îÄ‚îÄ Flow nav button clicks ‚îÄ‚îÄ
document.getElementById('btn-prev').addEventListener('click', () => skipToFlow(currentFlowIndex - 1));
document.getElementById('btn-next').addEventListener('click', () => skipToFlow(currentFlowIndex + 1));

// ‚îÄ‚îÄ Staggered entrance ‚îÄ‚îÄ
document.querySelectorAll('.node').forEach((node, i) => {
  node.style.opacity = '0';
  node.style.transform = 'translateY(12px) scale(0.95)';
  node.style.transition = 'opacity 0.4s ease, transform 0.4s ease, border-color 0.3s, box-shadow 0.3s, outline-color 0.3s';
  setTimeout(() => {
    node.style.opacity = '1';
    node.style.transform = 'translateY(0) scale(1)';
  }, 80 + i * 50);
});

document.querySelectorAll('.region').forEach((r, i) => {
  r.style.opacity = '0';
  r.style.transition = 'opacity 0.8s ease';
  setTimeout(() => { r.style.opacity = '0.5'; }, 200 + i * 150);
});

edgeSvg.style.opacity = '0';
edgeSvg.style.transition = 'opacity 1s ease';
setTimeout(() => { edgeSvg.style.opacity = '1'; }, 600);

// ‚îÄ‚îÄ Video Preview on Node Highlight ‚îÄ‚îÄ
const nodeVideoMap = {
  'depth':     { src: 'assets/depth-map.mp4',              label: 'Depth Map',              shift: 'default' },
  'masks':     { src: 'assets/IMG_4723_tracked_h264.mp4', label: 'Object Masks',           shift: 'default' },
  'obj-track': { src: 'assets/IMG_4723_composite_2x.mp4', label: 'Live Object Tracking',   shift: 'default' },
  'recon':     { src: 'assets/3d-reconstruction.mov',     label: '3D Reconstruction',      shift: 'none' },
  'pose':      { src: 'assets/6dof-user-pose.mp4',        label: '6DoF User Pose', speed: 2, shift: 'far' },
  'objdb':     { src: 'assets/3d-scene-object-graph.mov', label: '3D Scene Object Graph',  shift: 'none' },
};

Object.keys(nodeVideoMap).forEach(id => {
  const el = document.getElementById(id);
  if (el) el.classList.add('has-video');
  showcaseNodeIds.push(id);
});

const videoPreview = document.getElementById('videoPreview');
const previewVideo = document.getElementById('previewVideo');
const previewLabel = document.getElementById('previewLabel');

function showVideoPreview(nodeId, swap) {
  const mapping = nodeVideoMap[nodeId];
  if (!mapping) return;
  if (activeVideoNode === nodeId) return;
  const wasVisible = !!activeVideoNode;
  activeVideoNode = nodeId;
  previewLabel.textContent = mapping.label;
  previewVideo.src = mapping.src;
  previewVideo.playbackRate = mapping.speed || 1;
  previewVideo.play().catch(() => {});
  if (!wasVisible || !swap) {
    // Fresh open ‚Äî animate in
    videoPreview.classList.add('visible');
  }
  document.body.classList.remove('video-shift-default', 'video-shift-none', 'video-shift-far');
  document.body.classList.add('video-shift-' + (mapping.shift || 'default'));
  // Auto-scroll to keep the active node visible in the left half
  setTimeout(() => {
    const el = document.getElementById(nodeId);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

function hideVideoPreview() {
  if (!activeVideoNode) return;
  activeVideoNode = null;
  videoPreview.classList.remove('visible');
  document.body.classList.remove('video-shift-default', 'video-shift-none', 'video-shift-far');
  previewVideo.pause();
  previewVideo.removeAttribute('src');
  previewVideo.load();
  if (currentMode === 'explore') clearAllHighlights();
}

// Hook into explore mode ‚Äî click to show video, click elsewhere to dismiss
document.querySelectorAll('.node').forEach(node => {
  node.addEventListener('click', (e) => {
    if (currentMode !== 'explore') return;
    if (!nodeVideoMap[node.id]) return;
    e.stopPropagation();
    if (activeVideoNode === node.id) {
      hideVideoPreview();
    } else {
      highlightNode(node.id);
      showVideoPreview(node.id);
    }
  });
});
document.addEventListener('click', (e) => {
  if (currentMode !== 'explore') return;
  if (!activeVideoNode) return;
  if (videoPreview.contains(e.target)) return;
  hideVideoPreview();
});

// Hook into flow animation ‚Äî observe flow-active class (flow mode only)
const flowObserver = new MutationObserver((mutations) => {
  if (currentMode !== 'flow') return;
  mutations.forEach(m => {
    if (m.type === 'attributes' && m.attributeName === 'class') {
      const el = m.target;
      if (el.classList.contains('flow-active') && nodeVideoMap[el.id]) {
        showVideoPreview(el.id);
      } else if (!el.classList.contains('flow-active') && activeVideoNode === el.id) {
        hideVideoPreview();
      }
    }
  });
});
document.querySelectorAll('.node').forEach(node => {
  if (nodeVideoMap[node.id]) {
    flowObserver.observe(node, { attributes: true, attributeFilter: ['class'] });
  }
});
</script>
</body>
</html>
